services:

  # Databases
  # Auth DBs
  auth-mysql:
    image: mysql
    container_name: auth-mysql
    networks:
      - ecommerce
    ports:
      - "${AUTH_MYSQL_PORT}:3306"
    environment:
      - MYSQL_ROOT_PASSWORD= ${AUTH_MYSQL_ROOT_PASSWORD}

  auth-mongodb:
    image: mongo
    container_name: auth-mongodb
    networks:
      - ecommerce
    ports:
      - "${AUTH_MONGO_PORT}:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME= ${MONGO_INITDB_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD= ${MONGO_INITDB_ROOT_PASSWORD}

  auth-redis:
    image: redis
    container_name: auth-redis
    networks:
      - ecommerce
    ports:
      - "${AUTH_REDIS_PORT}:6379"

  #Broker 
  broker:
    build:
      context: ../../
      dockerfile: ./cmd/broker/Dockerfile
    container_name: broker
    networks:
      - ecommerce
    ports:
      - 8000:8000
    command: [ "./app" ]
    depends_on:
      - grafana

  #Authentication
  authentication:
    build:
      context: ../../
      dockerfile: ./cmd/authentication/Dockerfile
    container_name: authentication
    networks:
      - ecommerce
    ports:
      - 8001:8001
    command: [ "./app" ]
    depends_on:
      - grafana

  # Metrics, Logging and Tracing
  loki:
    image: grafana/loki
    container_name: loki
    networks:
      - ecommerce
    ports:
      - "3100:3100"

  grafana:
    image: grafana/grafana-oss
    container_name: grafana
    networks:
      - ecommerce
    ports:
      - "3000:3000"
    depends_on:
      - loki
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    volumes:
      - ../../config/grafana:/etc/grafana/provisioning
      - ../../config/grafana/dashboards:/var/lib/grafana/dashboards

  prometheus:
    image: prom/prometheus
    container_name: prometheus
    networks:
      - ecommerce
    command:
      - '--config.file=/etc/prometheus/prometheus.yaml'
    ports:
      - 9090:9090
    restart: unless-stopped
    volumes:
      - ./prometheus:/etc/prometheus
networks:
  ecommerce:
    driver: bridge
